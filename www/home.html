<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="css/home.css">
</head>
<body>

  <!-- Top Navigation Bar -->
  <nav class="navbar navbar-top">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <div>
        <span class="navbar-brand mb-0 h3">Welcome back,</span>
        <span class="navbar-name mb-0 h2" id="username-display">OMOMOMOMO</span>
      </div>
      <button class="btn btn-outline-danger" id="logout-btn">Logout</button>
      <div class="grey-stripe"></div>
    </div>
  </nav>

  <!-- Content Wrapper with Margin -->
  <div class="content">
    <!-- Total Expense Box -->
    <div class="container my-4">
      <div class="row justify-content-center">
        <div class="col-10 col-md-8">
          <div class="total-expense-box text-center p-4 rounded shadow">
            <h5 class="box-title">Total Expense for <span id="latest-month">this month</span></h5>
            <p class="box-amount" id="total-expense">RM0.00</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Expenses List -->
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-10 col-md-8">
          <h4>Recent Expenses</h4>
          <div class="list-group" id="recent-expenses">
            <!-- Recent expense items will be added here dynamically -->
          </div>
          <div class="text-center my-3">
            <a href="item.html" class="btn btn-primary">View All</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation Bar -->
  <nav class="navbar fixed-bottom navbar-light">
    <div class="container-fluid">
      <div class="d-flex justify-content-center w-100">
        <div class="nav-item">
          <a class="nav-link" href="home.html">
            <i class="bi bi-house"></i>
            <span>Home</span>
          </a>
        </div>
        <div class="nav-item">
          <a class="nav-link" href="item.html">
            <i class="bi bi-plus-circle"></i>
            <span>Item</span>
          </a>
        </div>
        <div class="nav-item">
          <a class="nav-link" href="#chart">
            <i class="bi bi-bar-chart"></i>
            <span>Chart</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        updateTotalExpense(); // Call the function to calculate and display total expense initially
        displayUsername(); // Display the username
    
        const currentUser = localStorage.getItem('currentUser');
        if (currentUser) {
            const items = JSON.parse(localStorage.getItem(`expenses_${currentUser}`)) || [];
            const expenseList = document.getElementById('recent-expenses');
    
            // Sort items by date
            items.sort((a, b) => new Date(b.date) - new Date(a.date));
    
            // Display the 4 most recent expenses
            displayRecentExpenses(items.slice(0, 4));
        } else {
            window.location.href = 'index.html';
        }
    });
    
    // Function to display username
    function displayUsername() {
        const currentUser = localStorage.getItem('currentUser');
        if (currentUser) {
            document.getElementById('username-display').textContent = currentUser;
        } else {
            window.location.href = 'index.html';
        }
    }
    
    // Function to handle logout
    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
    });
    
    // Function to update total expense and latest month
    function updateTotalExpense() {
        const currentUser = localStorage.getItem('currentUser');
        if (currentUser) {
            const items = JSON.parse(localStorage.getItem(`expenses_${currentUser}`)) || [];
            const totalExpenseElement = document.getElementById('total-expense');
            const latestMonthElement = document.getElementById('latest-month');
    
            const monthNames = ["January", "February", "March", "April", "May", "June",
                                "July", "August", "September", "October", "November", "December"];
    
            const latestDate = new Date();
            const latestMonth = latestDate.getMonth();
            const latestYear = latestDate.getFullYear();
            const totalExpense = items
                .filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate.getMonth() === latestMonth && itemDate.getFullYear() === latestYear;
                })
                .reduce((acc, item) => acc + item.amount, 0);
            totalExpenseElement.textContent = `RM${totalExpense.toFixed(2)}`;
            latestMonthElement.textContent = monthNames[latestMonth];
        } else {
            window.location.href = 'index.html';
        }
    }
    
    // Function to display recent expenses
    function displayRecentExpenses(expenses) {
        const expenseList = document.getElementById('recent-expenses');
        expenseList.innerHTML = ''; // Clear previous content
    
        expenses.forEach(expense => {
            const expenseItem = document.createElement('div');
            expenseItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
    
            const categoryIcon = document.createElement('i');
            categoryIcon.className = getCategoryIcon(expense.category);
    
            const expenseInfo = document.createElement('div');
            expenseInfo.classList.add('d-flex', 'align-items-center', 'flex-grow-1');
    
            const categoryText = document.createElement('div');
            categoryText.classList.add('ms-3');
            categoryText.innerHTML = `<div class="fw-bold">${expense.category}</div><div>${expense.name}</div>`;
    
            const amount = document.createElement('span');
            amount.classList.add('ms-auto', 'me-3');
            amount.textContent = `RM${expense.amount.toFixed(2)}`;
    
            expenseInfo.appendChild(categoryIcon);
            expenseInfo.appendChild(categoryText);
            expenseItem.appendChild(expenseInfo);
            expenseItem.appendChild(amount);
    
            expenseList.appendChild(expenseItem);
        });
    }
    
    // Event listener for changes in localStorage
    window.addEventListener('storage', () => {
        updateTotalExpense(); // Call the function to update total expense when localStorage changes
    });
    
    function getCategoryIcon(category) {
        switch (category) {
            case 'Food':
                return 'bi bi-cup-straw';
            case 'Bills':
                return 'bi bi-receipt';
            case 'Transportation':
                return 'bi bi-truck';
            case 'Groceries':
                return 'bi bi-cart';
            case 'Entertainment':
                return 'bi bi-controller';
            default:
                return 'bi bi-tags';
        }
    }
    </script>

</body>
</html>
